<!DOCTYPE html>
<html lang="ko">
  <!--
    ÏÇ¨Ïö©Ïûê Îì±Î°ù Î∞è Î°úÍ∑∏Ïù∏Ïù¥ ÌôúÏÑ±ÌôîÎêú ÏÉàÎ°úÏö¥ Î≤ÑÏ†ÑÏùò TodoList ÏõπÏÇ¨Ïù¥Ìä∏ÏûÖÎãàÎã§.
    Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÎäî Ìï†ÏùºÏùò ÏôÑÎ£å ÏÉÅÌÉúÎ•º ÌÜ†Í∏ÄÌïòÍ≥† Ìï†ÏùºÏùÑ ÏÇ≠Ï†úÌï† Ïàò ÏûàÏäµÎãàÎã§.
  -->
  <head>
    <title>TodoList Ïï±</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.135.0.min.js"></script>
    <script src="js/aws-cognito-sdk.min.js"></script>
    <script src="js/amazon-cognito-identity.min.js"></script>
    <style>
      body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        padding: 30px;
      }
      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
      }
      .auth-section {
        text-align: center;
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
      }
      .todo-form {
        display: flex;
        margin-bottom: 20px;
      }
      .todo-form input {
        flex-grow: 1;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px 0 0 8px;
        font-size: 16px;
        outline: none;
      }
      .todo-form input:focus {
        border-color: #667eea;
      }
      .todo-form button {
        padding: 12px 20px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 0 8px 8px 0;
        cursor: pointer;
        font-size: 16px;
      }
      .todo-form button:hover {
        background: #5a6fd8;
      }
      .todo-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin-bottom: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        transition: all 0.3s ease;
      }
      .todo-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      }
      .todo-item.completed {
        opacity: 0.7;
      }
      .todo-item input[type="checkbox"] {
        margin-right: 15px;
        transform: scale(1.2);
      }
      .todo-text {
        flex-grow: 1;
        font-size: 16px;
      }
      .todo-text.completed {
        text-decoration: line-through;
        color: #888;
      }
      .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        margin-left: 10px;
      }
      .delete-btn:hover {
        background: #c0392b;
      }
      .delete-btn:disabled {
        background: #cccccc;
        cursor: not-allowed;
      }
      .btn-auth {
        margin: 5px;
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
      .btn-primary {
        background: #007bff;
        color: white;
      }
      .btn-danger {
        background: #dc3545;
        color: white;
      }
      .btn-success {
        background: #28a745;
        color: white;
      }
      .d-none {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìù ÎÇòÏùò Ìï†Ïùº Î™©Î°ù</h1>
      
      <!-- Ïù∏Ï¶ù ÏÑπÏÖò -->
      <div class="auth-section">
        <div id="loggedOutSection">
          <p>Ìï†Ïùº ÏôÑÎ£å Î∞è ÏÇ≠Ï†úÎ•º ÏúÑÌï¥ Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.</p>
          <button type="button" id="logInButton" class="btn-auth btn-primary" data-toggle="modal" data-target="#loginModal">Î°úÍ∑∏Ïù∏ / ÌöåÏõêÍ∞ÄÏûÖ</button>
        </div>
        <div id="loggedInSection" class="d-none">
          <p>Î°úÍ∑∏Ïù∏ ÏÉÅÌÉúÏûÖÎãàÎã§.</p>
          <button type="button" id="logOutButton" class="btn-auth btn-danger">Î°úÍ∑∏ÏïÑÏõÉ</button>
        </div>
      </div>

      <!-- Ìï†Ïùº Ï∂îÍ∞Ä Ìèº -->
      <div class="todo-form">
        <input type="text" id="todoInput" placeholder="ÏÉàÎ°úÏö¥ Ìï†ÏùºÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
        <button type="button" id="addBtn">Ï∂îÍ∞Ä</button>
      </div>

      <!-- Ìï†Ïùº Î™©Î°ù -->
      <div id="todoList"></div>
    </div>

    <!-- Î°úÍ∑∏Ïù∏ Î™®Îã¨ -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Î°úÍ∑∏Ïù∏</h5>
            <button type="button" class="close" data-dismiss="modal">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="loginForm">
              <div class="form-group">
                <input type="email" class="form-control" id="email" placeholder="Ïù¥Î©îÏùº" required />
              </div>
              <div class="form-group">
                <input type="password" class="form-control" id="pwd" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏" required />
              </div>
              <button type="submit" class="btn btn-primary btn-block">Î°úÍ∑∏Ïù∏</button>
            </form>
            <div class="text-center mt-3">
              <a href="register.html" class="btn btn-success">ÌöåÏõêÍ∞ÄÏûÖ</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // API ÏóîÎìúÌè¨Ïù∏Ìä∏ Î∞è Cognito ÏÑ§Ï†ï
      var todosApiEndpoint = 'REPLACE_ME'; // example: 'https://abcd12345.execute-api.ap-northeast-2.amazonaws.com/prod'
      var cognitoUserPoolId = 'REPLACE_ME';  // example: 'ap-northeast-2_abcd12345'
      var cognitoUserPoolClientId = 'REPLACE_ME'; // example: 'abcd12345abcd12345abcd12345'
      var awsRegion = 'REPLACE_ME'; // example: 'ap-northeast-2'

      // Ï†ÑÏó≠ Î≥ÄÏàò
      let todos = [];
      let isLoggedIn = false;

      // Ï¥àÍ∏∞Ìôî
      $(document).ready(function() {
        initializeStorage();
        checkLoginStatus();
        loadTodos();
        
        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        $('#addBtn').click(addTodo);
        $('#todoInput').keypress(function(e) {
          if (e.which == 13) {
            addTodo();
          }
        });
        $('#loginForm').submit(loginUser);
        $('#logOutButton').click(logoutUser);
      });

      function initializeStorage() {
        var identityPoolId = cognitoUserPoolId;
        var userPoolId = cognitoUserPoolId;
        var clientId = cognitoUserPoolClientId;
        var loginPrefix = 'cognito-idp.' + awsRegion + '.amazonaws.com/' + identityPoolId;

        localStorage.setItem('identityPoolId', identityPoolId);
        localStorage.setItem('userPoolId', userPoolId);
        localStorage.setItem('clientId', clientId);
        localStorage.setItem('loginPrefix', loginPrefix);
      }

      function checkLoginStatus() {
        var configString = localStorage.getItem("awsConfig");
        var config = JSON.parse(configString);
        if(config != null) {
          refreshAWSCredentials();
          showLoggedInState();
        } else {
          showLoggedOutState();
        }
      }

      function showLoggedInState() {
        isLoggedIn = true;
        $("#loggedOutSection").addClass("d-none");
        $("#loggedInSection").removeClass("d-none");
        $("#loginModal").modal("hide");
      }

      function showLoggedOutState() {
        isLoggedIn = false;
        $("#loggedOutSection").removeClass("d-none");
        $("#loggedInSection").addClass("d-none");
      }

      function loginUser(event) {
        event.preventDefault();
        
        var email = document.getElementById('email').value;
        var password = document.getElementById('pwd').value;
        
        var poolData = {
          UserPoolId: cognitoUserPoolId,
          ClientId: cognitoUserPoolClientId
        };
        
        var userPool = new AmazonCognitoIdentity.CognitoUserPool(poolData);
        var userData = {
          Username: email,
          Pool: userPool
        };
        
        var cognitoUser = new AmazonCognitoIdentity.CognitoUser(userData);
        var authenticationData = {
          Username: email,
          Password: password
        };
        
        var authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails(authenticationData);
        
        cognitoUser.authenticateUser(authenticationDetails, {
          onSuccess: function(result) {
            console.log('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ');
            var accessToken = result.getAccessToken().getJwtToken();
            var idToken = result.getIdToken().getJwtToken();
            var refreshToken = result.getRefreshToken().getToken();
            
            var sessionTokens = {
              IdToken: result.idToken,
              AccessToken: result.accessToken,
              RefreshToken: result.refreshToken
            };
            
            localStorage.setItem('sessionTokens', JSON.stringify(sessionTokens));
            refreshAWSCredentials();
            showLoggedInState();
          },
          onFailure: function(err) {
            console.log('Î°úÍ∑∏Ïù∏ Ïã§Ìå®:', err);
            alert('Î°úÍ∑∏Ïù∏Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ' + err.message);
          }
        });
      }

      function logoutUser() {
        localStorage.clear();
        showLoggedOutState();
        loadTodos(); // Î°úÍ∑∏ÏïÑÏõÉ ÌõÑ Îã§Ïãú Î°úÎìúÌïòÏó¨ Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      }

      function refreshAWSCredentials() {
        var sessionTokensString = localStorage.getItem('sessionTokens');
        if (!sessionTokensString) return;
        
        var sessionTokens = JSON.parse(sessionTokensString);
        var config = {
          region: awsRegion,
          credentials: new AWS.CognitoIdentityCredentials({
            IdentityPoolId: cognitoUserPoolId
          })
        };
        
        localStorage.setItem('awsConfig', JSON.stringify(config));
      }

      function loadTodos() {
        $.ajax({
          url: todosApiEndpoint + '/todos',
          type: 'GET',
          success: function(response) {
            todos = response.todos || [];
            renderTodos();
          },
          error: function(xhr, status, error) {
            console.error('Ìï†Ïùº Î™©Î°ù Î°úÎìú Ïã§Ìå®:', error);
            alert('Ìï†Ïùº Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§ÎäîÎç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
          }
        });
      }

      function addTodo() {
        const todoText = $('#todoInput').val().trim();
        if (todoText === '') {
          alert('Ìï†ÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
          return;
        }

        $.ajax({
          url: todosApiEndpoint + '/todos',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ text: todoText }),
          success: function(response) {
            $('#todoInput').val('');
            loadTodos(); // ÏÉàÎ°úÍ≥†Ïπ®
          },
          error: function(xhr, status, error) {
            console.error('Ìï†Ïùº Ï∂îÍ∞Ä Ïã§Ìå®:', error);
            alert('Ìï†Ïùº Ï∂îÍ∞ÄÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
          }
        });
      }

      function toggleTodo(todoId) {
        if (!isLoggedIn) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.');
          return;
        }

        try {
          var sessionTokensString = localStorage.getItem('sessionTokens');
          var sessionTokens = JSON.parse(sessionTokensString);
          var IdToken = sessionTokens.IdToken;
          var idJwt = IdToken.jwtToken;

          $.ajax({
            url: todosApiEndpoint + '/todos/' + todoId + '/toggle',
            type: 'POST',
            headers: { 'Authorization': idJwt },
            success: function(response) {
              loadTodos(); // ÏÉàÎ°úÍ≥†Ïπ®
            },
            error: function(xhr, status, error) {
              console.error('Ìï†Ïùº ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïã§Ìå®:', error);
              if (xhr.status == 401) {
                refreshAWSCredentials();
              }
              alert('Ìï†Ïùº ÏÉÅÌÉú Î≥ÄÍ≤ΩÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
          });
        } catch (err) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.');
          console.log(err.message);
        }
      }

      function deleteTodo(todoId) {
        if (!isLoggedIn) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.');
          return;
        }

        if (!confirm('Ï†ïÎßêÎ°ú Ïù¥ Ìï†ÏùºÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
          return;
        }

        try {
          var sessionTokensString = localStorage.getItem('sessionTokens');
          var sessionTokens = JSON.parse(sessionTokensString);
          var IdToken = sessionTokens.IdToken;
          var idJwt = IdToken.jwtToken;

          $.ajax({
            url: todosApiEndpoint + '/todos/' + todoId,
            type: 'DELETE',
            headers: { 'Authorization': idJwt },
            success: function(response) {
              loadTodos(); // ÏÉàÎ°úÍ≥†Ïπ®
            },
            error: function(xhr, status, error) {
              console.error('Ìï†Ïùº ÏÇ≠Ï†ú Ïã§Ìå®:', error);
              if (xhr.status == 401) {
                refreshAWSCredentials();
              }
              alert('Ìï†Ïùº ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
            }
          });
        } catch (err) {
          alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌïú Í∏∞Îä•ÏûÖÎãàÎã§.');
          console.log(err.message);
        }
      }

      function renderTodos() {
        const todoList = $('#todoList');
        todoList.empty();

        if (todos.length === 0) {
          todoList.html('<div class="todo-item"><span class="todo-text">Ìï†ÏùºÏù¥ ÏóÜÏäµÎãàÎã§. ÏÉàÎ°úÏö¥ Ìï†ÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</span></div>');
          return;
        }

        todos.forEach(todo => {
          const todoItem = $(`
            <div class="todo-item ${todo.completed ? 'completed' : ''}">
              <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                     ${isLoggedIn ? '' : 'disabled'} 
                     onchange="toggleTodo(${todo.id})">
              <span class="todo-text ${todo.completed ? 'completed' : ''}">${todo.text}</span>
              <button class="delete-btn" 
                      ${isLoggedIn ? '' : 'disabled'} 
                      onclick="deleteTodo(${todo.id})">ÏÇ≠Ï†ú</button>
            </div>
          `);
          todoList.append(todoItem);
        });
      }
    </script>
  </body>
</html>
